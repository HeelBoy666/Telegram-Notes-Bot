{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<div class="row">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
                        </h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="updateCharts('7d')">7 –¥–Ω–µ–π</button>
                            <button type="button" class="btn btn-outline-primary" onclick="updateCharts('30d')">30 –¥–Ω–µ–π</button>
                            <button type="button" class="btn btn-outline-primary" onclick="updateCharts('90d')">90 –¥–Ω–µ–π</button>
                        </div>
                        <button class="btn btn-success ms-2" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
                        </button>
                        <button class="btn btn-info ms-2" onclick="showFilters()">
                            <i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
                        <h3 id="newUsersCount">-</h3>
                        <small id="newUsersChange">+0%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
                        <h3 id="activeUsersCount">-</h3>
                        <small id="activeUsersChange">+0%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>–ù–æ–≤—ã–µ –∑–∞–º–µ—Ç–∫–∏</h5>
                        <h3 id="newNotesCount">-</h3>
                        <small id="newNotesChange">+0%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5>–†–µ—Ñ–µ—Ä–∞–ª—ã</h5>
                        <h3 id="referralsCount">-</h3>
                        <small id="referralsChange">+0%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> –¢–æ–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <canvas id="referralsChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞–º–µ—Ç–æ–∫ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–º–µ—Ç–æ–∫
                </h5>
            </div>
            <div class="card-body">
                <canvas id="notesChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-doughnut"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
                </h5>
            </div>
            <div class="card-body">
                <canvas id="rolesChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy"></i> –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </h5>
            </div>
            <div class="card-body">
                <div id="topUsersList">
                    <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                </h5>
            </div>
            <div class="card-body">
                <canvas id="timeChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe"></i> –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="geoChart" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div id="geoStats">
                            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="analyticsDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailModalContent">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
<div class="modal fade" id="filtersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterRole" class="form-label">–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                            <select class="form-select" id="filterRole">
                                <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                                <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                                <option value="admin">Admin</option>
                                <option value="main_admin">–ì–ª–∞–≤–Ω—ã–µ –∞–¥–º–∏–Ω—ã</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterTimezone" class="form-label">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                            <select class="form-select" id="filterTimezone">
                                <option value="">–í—Å–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞</option>
                                <option value="moscow">–ú–æ—Å–∫–≤–∞ (UTC+3)</option>
                                <option value="ekaterinburg">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (UTC+5)</option>
                                <option value="novosibirsk">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ (UTC+7)</option>
                                <option value="vladivostok">–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ (UTC+10)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterMinNotes" class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫</label>
                            <input type="number" class="form-control" id="filterMinNotes" min="0" value="0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterMinReferrals" class="form-label">–ú–∏–Ω. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</label>
                            <input type="number" class="form-control" id="filterMinReferrals" min="0" value="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="filterEndDate" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterActiveOnly">
                        <label class="form-check-label" for="filterActiveOnly">
                            –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterWithReferrals">
                        <label class="form-check-label" for="filterWithReferrals">
                            –¢–æ–ª—å–∫–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterRecentActivity">
                        <label class="form-check-label" for="filterRecentActivity">
                            –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPeriod = '30d';
let charts = {};
let currentFilters = {};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    initCharts();
    initNotifications();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function initNotifications() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(checkImportantMetrics, 5 * 60 * 1000);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–æ–º–∞–ª–∏–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
    setInterval(checkAnomalies, 60 * 60 * 1000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–∂–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
function checkImportantMetrics() {
    fetch(`/api/analytics/overview?period=1d`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const metrics = data.metrics;
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑–∫–æ–º —Ä–æ—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (metrics.new_users_change > 50) {
                    showNotification(`üöÄ –†–µ–∑–∫–∏–π —Ä–æ—Å—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: +${metrics.new_users_change}%`, 'success');
                }
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–∞–¥–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                if (metrics.active_users_change < -20) {
                    showNotification(`‚ö†Ô∏è –ü–∞–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${metrics.active_users_change}%`, 'warning');
                }
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–º–µ—Ç–æ–∫
                if (metrics.new_notes > 100) {
                    showNotification(`üìù –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${metrics.new_notes} –Ω–æ–≤—ã—Ö –∑–∞–º–µ—Ç–æ–∫`, 'info');
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ—Ç—Ä–∏–∫:', error);
        });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π
function checkAnomalies() {
    fetch('/api/analytics/anomalies')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.anomalies.length > 0) {
                data.anomalies.forEach(anomaly => {
                    showNotification(`üö® –ê–Ω–æ–º–∞–ª–∏—è: ${anomaly.description}`, 'error');
                });
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–Ω–æ–º–∞–ª–∏–π:', error);
        });
}

// –ü–æ–∫–∞–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function showFilters() {
    const modal = new bootstrap.Modal(document.getElementById('filtersModal'));
    modal.show();
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function applyFilters() {
    currentFilters = {
        role: document.getElementById('filterRole').value,
        timezone: document.getElementById('filterTimezone').value,
        minNotes: document.getElementById('filterMinNotes').value,
        minReferrals: document.getElementById('filterMinReferrals').value,
        startDate: document.getElementById('filterStartDate').value,
        endDate: document.getElementById('filterEndDate').value,
        activeOnly: document.getElementById('filterActiveOnly').checked,
        withReferrals: document.getElementById('filterWithReferrals').checked,
        recentActivity: document.getElementById('filterRecentActivity').checked
    };
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('filtersModal'));
    modal.hide();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    loadAnalyticsWithFilters();
    
    showNotification('–§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearFilters() {
    document.getElementById('filterRole').value = '';
    document.getElementById('filterTimezone').value = '';
    document.getElementById('filterMinNotes').value = '0';
    document.getElementById('filterMinReferrals').value = '0';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    document.getElementById('filterActiveOnly').checked = false;
    document.getElementById('filterWithReferrals').checked = false;
    document.getElementById('filterRecentActivity').checked = false;
    
    currentFilters = {};
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    loadAnalytics();
    
    showNotification('–§–∏–ª—å—Ç—Ä—ã –æ—á–∏—â–µ–Ω—ã', 'info');
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function loadAnalyticsWithFilters() {
    const params = new URLSearchParams({
        period: currentPeriod,
        ...currentFilters
    });
    
    fetch(`/api/analytics/overview?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMetrics(data.metrics);
                updateCharts(data.charts);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function updateChartsWithFilters(period) {
    currentPeriod = period;
    
    const params = new URLSearchParams({
        period: period,
        ...currentFilters
    });
    
    fetch(`/api/analytics/charts?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChartData(data.charts);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤', 'error');
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
function updateChartData(charts) {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#ffffff' : '#212529';
    const gridColor = isDark ? '#404040' : '#e9ecef';
    
    // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const commonOptions = {
        plugins: {
            legend: {
                labels: {
                    color: textColor
                }
            }
        },
        scales: {
            x: {
                ticks: { color: textColor },
                grid: { color: gridColor }
            },
            y: {
                ticks: { color: textColor },
                grid: { color: gridColor }
            }
        }
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    charts.activity.data.labels = charts.activity.labels;
    charts.activity.data.datasets[0].data = charts.activity.new_users;
    charts.activity.data.datasets[1].data = charts.activity.active_users;
    charts.activity.options = { ...charts.activity.options, ...commonOptions };
    charts.activity.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    charts.referrals.data.labels = charts.referrals.labels;
    charts.referrals.data.datasets[0].data = charts.referrals.data;
    charts.referrals.options = { ...charts.referrals.options, ...commonOptions };
    charts.referrals.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∑–∞–º–µ—Ç–æ–∫
    charts.notes.data.labels = charts.notes.labels;
    charts.notes.data.datasets[0].data = charts.notes.data;
    charts.notes.options = { ...charts.notes.options, ...commonOptions };
    charts.notes.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ä–æ–ª–µ–π
    charts.roles.data.datasets[0].data = charts.roles;
    charts.roles.options = { ...charts.roles.options, ...commonOptions };
    charts.roles.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏
    charts.time.data.datasets[0].data = charts.time;
    charts.time.options = { ...charts.time.options, ...commonOptions };
    charts.time.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫
    charts.geo.data.labels = charts.geo.labels;
    charts.geo.data.datasets[0].data = charts.geo.data;
    charts.geo.options = { ...charts.geo.options, ...commonOptions };
    charts.geo.update();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    updateTopUsers(charts.top_users);
    updateGeoStats(charts.geo_stats);
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
function loadAnalytics() {
    fetch(`/api/analytics/overview?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMetrics(data.metrics);
                updateCharts(data.charts);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
function updateMetrics(metrics) {
    document.getElementById('newUsersCount').textContent = metrics.new_users;
    document.getElementById('newUsersChange').textContent = metrics.new_users_change + '%';
    document.getElementById('activeUsersCount').textContent = metrics.active_users;
    document.getElementById('activeUsersChange').textContent = metrics.active_users_change + '%';
    document.getElementById('newNotesCount').textContent = metrics.new_notes;
    document.getElementById('newNotesChange').textContent = metrics.new_notes_change + '%';
    document.getElementById('referralsCount').textContent = metrics.referrals;
    document.getElementById('referralsChange').textContent = metrics.referrals_change + '%';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    charts.activity = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    const referralsCtx = document.getElementById('referralsChart').getContext('2d');
    charts.referrals = new Chart(referralsCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–º–µ—Ç–æ–∫
    const notesCtx = document.getElementById('notesChart').getContext('2d');
    charts.notes = new Chart(notesCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–æ–ª–µ–π
    const rolesCtx = document.getElementById('rolesChart').getContext('2d');
    charts.roles = new Chart(rolesCtx, {
        type: 'pie',
        data: {
                                    labels: ['–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', 'Admin', 'Boss'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    charts.time = new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
            datasets: [{
                label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                data: [],
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫
    const geoCtx = document.getElementById('geoChart').getContext('2d');
    charts.geo = new Chart(geoCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function updateCharts(period) {
    currentPeriod = period;
    
    fetch(`/api/analytics/charts?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                charts.activity.data.labels = data.activity.labels;
                charts.activity.data.datasets[0].data = data.activity.new_users;
                charts.activity.data.datasets[1].data = data.activity.active_users;
                charts.activity.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                charts.referrals.data.labels = data.referrals.labels;
                charts.referrals.data.datasets[0].data = data.referrals.data;
                charts.referrals.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∑–∞–º–µ—Ç–æ–∫
                charts.notes.data.labels = data.notes.labels;
                charts.notes.data.datasets[0].data = data.notes.data;
                charts.notes.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ä–æ–ª–µ–π
                charts.roles.data.datasets[0].data = data.roles;
                charts.roles.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏
                charts.time.data.datasets[0].data = data.time;
                charts.time.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ–∏–∫
                charts.geo.data.labels = data.geo.labels;
                charts.geo.data.datasets[0].data = data.geo.data;
                charts.geo.update();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                updateTopUsers(data.top_users);
                updateGeoStats(data.geo_stats);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function updateTopUsers(topUsers) {
    const container = document.getElementById('topUsersList');
    container.innerHTML = '';
    
    topUsers.forEach((user, index) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'd-flex justify-content-between align-items-center mb-2';
        userDiv.innerHTML = `
            <div>
                <span class="badge bg-primary me-2">${index + 1}</span>
                <strong>${user.username}</strong>
                <small class="text-muted d-block">${user.notes_count} –∑–∞–º–µ—Ç–æ–∫</small>
            </div>
            <div class="text-end">
                <span class="badge bg-success">${user.referrals_count} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</span>
            </div>
        `;
        container.appendChild(userDiv);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateGeoStats(geoStats) {
    const container = document.getElementById('geoStats');
    container.innerHTML = `
        <h6>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º:</h6>
        <div class="mb-2">
            <strong>–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω:</strong> ${geoStats.total_countries}
        </div>
        <div class="mb-2">
            <strong>–¢–æ–ø —Ä–µ–≥–∏–æ–Ω:</strong> ${geoStats.top_region}
        </div>
        <div class="mb-2">
            <strong>–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å—Ç—Ä–∞–Ω—É:</strong> ${geoStats.avg_per_country}
        </div>
    `;
}

// –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
function exportAnalytics() {
    fetch(`/api/analytics/export?period=${currentPeriod}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_${currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏', 'error');
        });
}

// –ü–æ–∫–∞–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫
function showChartDetails(chartType, data) {
    const modal = new bootstrap.Modal(document.getElementById('analyticsDetailModal'));
    const title = document.getElementById('detailModalTitle');
    const content = document.getElementById('detailModalContent');
    
    title.textContent = `–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: ${chartType}`;
    content.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>–î–∞–Ω–Ω—ã–µ:</h6>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
        </div>
    `;
    
    modal.show();
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    document.getElementById('activityChart').addEventListener('click', function(e) {
        const chart = charts.activity;
        const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
        if (points.length) {
            const firstPoint = points[0];
            const label = chart.data.labels[firstPoint.index];
            const data = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
            showChartDetails('–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', { label, data });
        }
    });
});
</script>
{% endblock %} 